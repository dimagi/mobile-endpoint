<?xml version="1.0"?>
<!DOCTYPE tsung SYSTEM "{{ dtd_path }}" [
    <!ENTITY connect_auth SYSTEM "{{ transactions_dir }}/connect_auth.xml">
    <!ENTITY new_case SYSTEM "{{ transactions_dir }}/new_case.xml">
    <!ENTITY update_case SYSTEM "{{ transactions_dir }}/update_case.xml">
    <!ENTITY cases_by_owner_modified SYSTEM "{{ transactions_dir }}/get_cases_by_owner_modified_on.xml">
    <!ENTITY related_cases SYSTEM "{{ transactions_dir }}/get_related_cases.xml">
    <!ENTITY disconnect SYSTEM "{{ transactions_dir }}/disconnect.xml">
]>
<tsung loglevel="info">
    <clients>
        <client host="localhost" use_controller_vm="true" maxusers="30000"/>
    </clients>

    <servers>
        <server host="{{ host }}" port="{{ port }}" type="tcp"></server>
    </servers>

    <load>
        {% for phase in phases %}
        <arrivalphase phase="{{ loop.index }}" duration="{{ phase.duration }}" unit="second">
            <users arrivalrate="{{ phase.arrival_rate}}" unit="second"></users>
        </arrivalphase>
        {% endfor %}
    </load>

    <options>
        <option name="file_server" id="casedb" value="{{ casedb }}"></option>
        <option name="file_server" id="formdb" value="{{ formdb }}"></option>
    </options>

    <sessions>
        <session probability="50" name="new-case-get-by-owner-modified" type="{{ session_type }}">
            <setdynvars sourcetype="file" fileid="userdb" delimiter="," order="random">
                <var name="user_id" />
                <var name="username" />
                <var name="password" />
            </setdynvars>

            <setdynvars sourcetype="eval"
                    code="fun({Pid,DynVars})->
                              uuid:random_str() end.">
              <var name="case_id" />
            </setdynvars>

            &connect_auth;
            &new_case;
            &cases_by_owner_modified;
            &disconnect;
        </session>

        <session probability="50" name="update-case-get-related" type="{{ session_type }}">
            <setdynvars sourcetype="file" fileid="userdb" delimiter="," order="random">
                <var name="user_id" />
                <var name="username" />
                <var name="password" />
            </setdynvars>

            <setdynvars sourcetype="file" fileid="casedb" delimiter="," order="random">
                <var name="case_id" />
            </setdynvars>

            &connect_auth;
            &update_case;
            &related_cases;
            &disconnect;

        </session>

    </sessions>

</tsung>
